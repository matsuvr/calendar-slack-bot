# Calendar Slack Bot 設計ドキュメント

このドキュメントは、Calendar Slack Botの内部設計と実装に関する詳細を開発者向けに提供します。

## 1. 技術スタック

- **バックエンド**: Node.js (v20+)
- **フレームワーク**: Express、Slack Bolt
- **AI処理**: Google Gemini API
- **デプロイ環境**: Google Cloud Run
- **ロギング**: Console logs（Cloud Run環境ではCloud Loggingに自動転送）

## 2. コアコンポーネント

### 2.1. メインアプリケーション (`server.js`)

- HTTPサーバーの初期化と設定
- Slack Boltアプリケーションの初期化
- イベントリスナーの設定
- エラーハンドリング

### 2.2. イベントハンドラー (`eventHandlers.js`)

- `reaction_added`イベントの処理
- メッセージ取得処理
- リアクション検証

### 2.3. 予定抽出エンジン (`eventExtractor.js`)

- Gemini APIとの通信
- テキスト解析とJSON変換
- フォールバックメカニズム

### 2.4. カレンダーURL生成器 (`calendarUrlGenerator.js`)

- Google CalendarのURL構築
- 日時フォーマット変換
- パラメータエンコード

### 2.5. テキスト要約モジュール (`summarizer.js`)

- 長文を100文字に要約
- 重要情報の保持ロジック
- マルチソースサマリー

## 3. 処理フロー

```
1. ユーザーがSlackのメッセージにカレンダー絵文字をつける
2. Slack APIがBotへreaction_addedイベントを送信
3. Botがリアクション種類を検証（カレンダー関連か）
4. 対象メッセージのテキストを取得
5. Gemini APIを使用して予定情報を抽出
6. 予定情報がない場合はエラーメッセージ返信
7. 予定情報をパース・整形
8. 説明が長い場合は要約処理
9. Google Calendar URLを構築
10. 結果をSlackスレッドに返信
```

## 4. Gemini APIプロンプト設計

予定抽出に使用するプロンプトの設計は以下の通りです：

```
あなたはSlackメッセージからカレンダー予定情報を抽出するアシスタントです。
以下のテキストから、予定に関する情報を抽出し、JSON形式で返してください。

予定に関する情報:
- title: 予定のタイトル（必須）
- date: 予定の日付 "YYYY-MM-DD"形式（必須）
- startTime: 開始時間 "HH:MM"形式（必須）
- endTime: 終了時間 "HH:MM"形式（オプション）
- location: 場所（オプション）
- description: 詳細説明（オプション）

出力形式:
{
  "title": "ミーティング",
  "date": "2025-04-21",
  "startTime": "14:00",
  "endTime": "15:00",
  "location": "会議室A",
  "description": "プロジェクトの進捗確認"
}

テキスト:
"""
{{INPUT_TEXT}}
"""
```

## 5. エラーハンドリング戦略

### 5.1. API接続エラー

- 3回までの自動リトライ（指数バックオフ）
- フォールバックモードへの切り替え
- エラーログ記録

### 5.2. 予定情報抽出エラー

- 代替プロンプトでのリトライ
- レガシーパースモードへのフォールバック
- 明確なエラーメッセージをユーザーに提供

### 5.3. 環境変数検証

- 起動時に必須環境変数の存在確認
- 詳細なエラーメッセージ
- Cloud Runログへの記録

## 6. スケーリング考慮事項

- メモリ使用量の最適化（Gemini API呼び出し効率化）
- Cloud Runの自動スケーリング活用
- 並列リクエスト処理の考慮

## 7. 開発環境セットアップ

1. リポジトリのクローン
2. 依存関係のインストール
3. `.env.example`を`.env`にコピーし、各APIキーを設定
4. Slackアプリを作成し、イベント通知設定
5. ローカル開発用ngrokもしくはCloud Runのデプロイを設定
6. `npm run dev`で開発サーバー起動

## 8. テスト戦略

### 8.1. ユニットテスト

- 予定抽出ロジックのテスト
- URL生成のテスト
- テキスト要約機能のテスト

### 8.2. 統合テスト

- Slackイベント処理のエンドツーエンドテスト
- Gemini APIとの連携テスト

### 8.3. 負荷テスト

- 同時多数リクエスト時の挙動確認
- メモリリークチェック

## 9. カスタマイズオプション

### 9.1. カスタムリアクション

`config.js`で追加のリアクションをトリガーとして設定可能:

```javascript
const CALENDAR_REACTIONS = [
  'calendar',
  'カレンダー',
  // カスタムリアクションをここに追加
];
```

### 9.2. Geminiプロンプトのカスタマイズ

`prompts.js`でGemini APIへのプロンプトをカスタマイズ可能:

```javascript
const EVENT_EXTRACTION_PROMPT = `あなたはSlackメッセージから...`;
```

### 9.3. 要約パラメータの調整

`config.js`で要約の長さなどのパラメータを調整可能:

```javascript
const SUMMARY_MAX_LENGTH = 100; // 文字数
```

## 10. 今後の拡張計画

- 複数予定の同時抽出と処理
- 予定の衝突検出機能
- Google Calendarとの直接同期
- ユーザー設定による予定テンプレート

## 11. トラブルシューティング

### 11.1. Slackイベントが届かない

- Slack APIのイベント購読設定を確認
- URLとパスの正確性を確認
- 署名シークレットの正確性を確認

### 11.2. Gemini APIエラー

- APIキーの有効性確認
- レート制限の確認
- プロンプト設計の最適化

### 11.3. Cloud Run関連問題

- 環境変数の設定確認
- サービスアカウント権限の確認
- ログ分析による原因特定