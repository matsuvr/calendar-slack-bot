# Calendar Slack Bot 設計ドキュメント

このドキュメントは、Calendar Slack Botの内部設計と実装に関する詳細を開発者向けに提供します。

## 1. 技術スタック

- **バックエンド**: Node.js (v20+)
- **フレームワーク**: Express、Slack Bolt
- **AI処理**: Google Gemini API
- **データベース**: Firestore (Google Cloud)
- **デプロイ環境**: Google Cloud Run
- **ロギング**: Console logs（Cloud Run環境ではCloud Loggingに自動転送）

## 2. コアコンポーネント

### 2.1. メインアプリケーション (`server.js`)

- HTTPサーバーの初期化と設定
- Slack Boltアプリケーションの初期化
- イベントリスナーの設定
- エラーハンドリング
- デモモードとプロダクションモードの切り替え

### 2.2. Slackイベントハンドラー (`src/handlers/slackHandlers.js`)

- `reaction_added`イベントの処理
- メッセージ取得処理
- リアクション検証
- 抽出された予定情報のフォーマットと返信

### 2.3. AI処理サービス (`src/services/aiService.js`)

- Gemini APIとの通信
- テキスト解析とJSON変換
- テキスト要約機能
- フォールバックメカニズム（レガシーモード）

### 2.4. Firestoreサービス (`src/services/firestoreService.js`)

- 処理済みリアクションの管理
- トランザクション処理
- 読み取り専用モードの対応

### 2.5. カレンダーユーティリティ (`src/utils/calendarUtils.js`)

- Google CalendarのURL構築
- 日時フォーマット変換
- パラメータエンコード
- オンラインミーティングURL検出

### 2.6. 設定管理 (`src/config/config.js`)

- 環境変数の読み込みと検証
- アプリケーション設定の一元管理
- カスタマイズ可能なパラメータの提供

## 3. 処理フロー

```
1. ユーザーがSlackのメッセージにカレンダー絵文字をつける
2. Slack APIがBotへreaction_addedイベントを送信
3. Botがリアクション種類を検証（カレンダー関連か）
4. Firestoreで既に処理済みのリアクションかチェック
5. 対象メッセージのテキストを取得
6. Gemini APIを使用して予定情報を抽出
7. 予定情報がない場合はエラーメッセージ返信
8. 複数の予定が検出された場合の処理（最大件数制限）
9. 説明が長い場合は要約処理
10. Google Calendar URLを構築（オンラインミーティングURLも検出）
11. 結果をSlackスレッドに返信
```

## 4. Gemini APIプロンプト設計

予定抽出に使用するプロンプトの設計は以下の通りです：

```
あなたはテキストから予定やイベント情報を抽出するシステムです。
テキストから予定情報を見つけて、JSONスキーマに沿った形式でレスポンスを返してください。
複数の予定が含まれている場合は、それぞれを個別に抽出してください。
予定が見つからない場合は空の配列[]を返してください。
      
現在の日時は ${currentDate} ${currentTime} であることを考慮してください。
```

## 5. エラーハンドリング戦略

### 5.1. API接続エラー

- フォールバックモードへの切り替え（レガシーモード）
- エラーログ記録
- ユーザーへの明確なエラーメッセージ

### 5.2. 予定情報抽出エラー

- JSON解析エラー時の代替パース方法
- レガシーモードでの予定抽出
- 明確なエラーメッセージをユーザーに提供

### 5.3. 環境変数検証

- 起動時に必須環境変数の存在確認
- 詳細なエラーメッセージ
- デモモードへの自動切り替え

## 6. スケーリング考慮事項

- メモリ使用量の最適化（Gemini API呼び出し効率化）
- Cloud Runの自動スケーリング活用
- Firestoreトランザクションによる並列処理
- 予定抽出の最大件数制限

## 7. 開発環境セットアップ

1. リポジトリのクローン
2. 依存関係のインストール
3. `.env.example`を`.env`にコピーし、各APIキーを設定
4. Slackアプリを作成し、イベント通知設定
5. ローカル開発用ngrokもしくはCloud Runのデプロイを設定
6. `npm run dev`で開発サーバー起動

## 8. テスト戦略

### 8.1. ユニットテスト

- 予定抽出ロジックのテスト
- URL生成のテスト
- テキスト要約機能のテスト

### 8.2. 統合テスト

- Slackイベント処理のエンドツーエンドテスト
- Gemini APIとの連携テスト
- Firestoreとの統合テスト

### 8.3. 負荷テスト

- 同時多数リクエスト時の挙動確認
- メモリリークチェック
- 長文処理の性能テスト

## 9. カスタマイズオプション

### 9.1. カスタムリアクション

`config.js`で追加のリアクションをトリガーとして設定可能:

```javascript
const calendarReactions = [
  'calendar', 
  'カレンダー', 
  'calendar_spiral', 
  'date', 
  'カレンダーに入れる', 
  'calendar-bot'
];
```

### 9.2. Geminiモデルのカスタマイズ

`config.js`でGemini APIのモデルを設定可能:

```javascript
const gemini = {
  apiKey: process.env.GEMINI_API_KEY,
  models: {
    summarize: 'gemini-2.0-flash-lite',
    extract: 'gemini-2.0-flash',
  },
};
```

### 9.3. 要約と予定件数の調整

`config.js`で要約の長さや最大予定件数などのパラメータを調整可能:

```javascript
const app = {
  maxEvents: 5,  // 一度に処理する最大予定件数
};

const calendar = {
  defaultDuration: 60,  // 予定のデフォルト時間（分）
};
```

## 10. 今後の拡張計画

- 複数予定の同時抽出と処理の改善
- 予定の衝突検出機能
- Google Calendarとの直接同期
- ユーザー設定による予定テンプレート
- 定期的な予定の適切な処理

## 11. トラブルシューティング

### 11.1. Slackイベントが届かない

- Slack APIのイベント購読設定を確認
- URLとパスの正確性を確認
- 署名シークレットの正確性を確認
- サーバーログでリクエスト受信を確認

### 11.2. Gemini APIエラー

- APIキーの有効性確認
- レート制限の確認
- プロンプト設計の最適化
- モデル指定の確認（gemini-2.0-flash-lite/flash）

### 11.3. Cloud Run関連問題

- 環境変数の設定確認
- サービスアカウント権限の確認
- メモリ設定の確認
- ログ分析による原因特定