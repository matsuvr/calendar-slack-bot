# Calendar Slack Bot 設計ドキュメント

このドキュメントは、Calendar Slack Botの内部設計と実装に関する詳細を開発者向けに提供します。

## 1. 技術スタック

- **バックエンド**: Node.js (v20+)
- **フレームワーク**: Express、Slack Bolt
- **AI処理**: Google Gemini API（gemini-2.5-flash）
- **重複除去**: メモリ内キャッシュ（TTL付き）
- **デプロイ環境**: Google Cloud Run
- **ロギング**: Console logs（Cloud Run環境ではCloud Loggingに自動転送）

## 2. コアコンポーネント

### 2.1. メインアプリケーション (`server.js`)

- HTTPサーバーの初期化と設定
- Slack Boltアプリケーションの初期化
- イベントリスナーの設定
- エラーハンドリング
- デモモードとプロダクションモードの切り替え

### 2.2. Slackイベントハンドラー (`src/handlers/slackHandlers.js`)

- `reaction_added`イベントの処理
- メッセージ取得と前処理（Slackマークアップ除去、URL周りのスペース調整）
- リアクション検証
- メモリ内重複除去システム（TTL付きキャッシュ）
- 抽出された予定情報のフォーマットと返信
- AIタイトル生成機能

### 2.3. AI処理サービス (`src/services/aiService.js`)

- Gemini API（gemini-2.5-flash）との通信
- リトライ機能付きAPI呼び出し
- テキスト解析とJSON変換
- 構造化されたイベント抽出
- AIベースのカレンダータイトル生成
- テキスト要約機能（100文字以内）

### 2.4. カレンダーユーティリティ (`src/utils/calendarUtils.js`)

- Google CalendarのURL構築
- 日時フォーマット変換
- パラメータエンコード
- オンラインミーティングURL検出と場所パラメータへの組み込み
- Slackマークアップ除去（早期段階）
- 日本語テキスト周りのURL処理（スペース調整）

### 2.5. 設定管理 (`src/config/config.js`)

- 環境変数の読み込みと検証
- アプリケーション設定の一元管理
- Geminiモデル設定（extract用、summarize用、lite用）
- カスタマイズ可能なパラメータの提供

## 3. 処理フロー

```
1. ユーザーがSlackのメッセージにカレンダー絵文字をつける
2. Slack APIがBotへreaction_addedイベントを送信
3. Botがリアクション種類を検証（カレンダー関連か）
4. メモリ内キャッシュで既に処理済みのリアクションかチェック（TTL: 5分）
5. 対象メッセージのテキストを取得
6. 早期段階でSlackマークアップを除去し、URL周りにスペースを挿入
7. Gemini API（gemini-2.5-flash）を使用して予定情報を抽出
8. 予定情報がない場合はエラーメッセージ返信
9. 複数の予定が検出された場合の処理（最大件数制限）
10. AIを使用してカレンダータイトルを生成（キャッシュ付き）
11. 説明が長い場合は要約処理
12. Google Calendar URLを構築（オンラインミーティングURLも場所に組み込み）
13. 結果をSlackスレッドに返信
14. 処理済みリアクションをメモリ内キャッシュに記録
```

## 4. Gemini APIプロンプト設計

### 4.1. イベント抽出プロンプト

予定抽出に使用するプロンプトの設計は以下の通りです：

```
あなたはテキストから予定やイベント情報を抽出するシステムです。
テキストから予定情報を見つけて、JSONスキーマに沿った形式でレスポンスを返してください。
複数の予定が含まれている場合は、それぞれを個別に抽出してください。
予定が見つからない場合は空の配列[]を返してください。
      
現在の日時は ${currentDate} ${currentTime} であることを考慮してください。
```

### 4.2. カレンダータイトル生成プロンプト

AIによるタイトル生成では、以下のような簡潔で明確なタイトル生成を行います：

```
以下の予定情報から、Googleカレンダーに適した簡潔なタイトルを生成してください。
- 30文字以内
- 重要な情報を含む
- 分かりやすい表現
```

## 5. エラーハンドリング戦略

### 5.1. API接続エラー

- Gemini APIへのリトライ機能（指数バックオフ）
- 明確なエラーログ記録
- ユーザーへの分かりやすいエラーメッセージ

### 5.2. 予定情報抽出エラー

- JSON解析エラー時の適切な処理
- 構造化データ検証
- 明確なエラーメッセージをユーザーに提供

### 5.3. 環境変数検証

- 起動時に必須環境変数の存在確認
- 詳細なエラーメッセージ
- デモモードへの自動切り替え

### 5.4. メモリ管理

- TTL付きキャッシュによる自動クリーンアップ
- メモリリーク防止
- 定期的なキャッシュサイズ監視

## 6. スケーリング考慮事項

- メモリ使用量の最適化（Gemini API呼び出し効率化）
- Cloud Runの自動スケーリング活用
- メモリ内キャッシュによる高速な重複除去
- 予定抽出の最大件数制限
- TTL付きキャッシュによるメモリ効率化

## 7. 開発環境セットアップ

1. リポジトリのクローン
2. 依存関係のインストール
3. `.env.example`を`.env`にコピーし、各APIキーを設定
4. Slackアプリを作成し、イベント通知設定
5. ローカル開発用ngrokもしくはCloud Runのデプロイを設定
6. `npm run dev`で開発サーバー起動

**注意**: Firestoreの設定は不要になりました（メモリ内キャッシュを使用）。

## 8. テスト戦略

### 8.1. ユニットテスト

- 予定抽出ロジックのテスト
- URL生成のテスト
- テキスト要約機能のテスト

### 8.2. 統合テスト

- Slackイベント処理のエンドツーエンドテスト
- Gemini APIとの連携テスト
- メモリ内キャッシュの動作テスト

### 8.3. 負荷テスト

- 同時多数リクエスト時の挙動確認
- メモリリークチェック
- 長文処理の性能テスト
- キャッシュ効率の検証

## 9. カスタマイズオプション

### 9.1. カスタムリアクション

`config.js`で追加のリアクションをトリガーとして設定可能:

```javascript
const calendarReactions = [
  'calendar', 
  'カレンダー', 
  'calendar_spiral', 
  'date', 
  'カレンダーに入れる', 
  'calendar-bot'
];
```

### 9.2. Geminiモデルのカスタマイズ

`config.js`でGemini APIのモデルを設定可能:

```javascript
const gemini = {
  apiKey: process.env.GEMINI_API_KEY,
  models: {
    summarize: 'gemini-2.5-flash-preview-06-17',
    extract: 'gemini-2.5-flash-preview-06-17',
    lite: 'gemini-2.5-flash-preview-06-17'
  },
};
```

### 9.3. キャッシュとパフォーマンスの調整

`config.js`でキャッシュTTLや処理パラメータを調整可能:

```javascript
const app = {
  maxEvents: 5,  // 一度に処理する最大予定件数
};

const calendar = {
  defaultDuration: 60,  // 予定のデフォルト時間（分）
};

// ハンドラー内で設定されるキャッシュTTL
const REACTION_CACHE_TTL = 300000; // 5分間キャッシュ
```

## 10. 今後の拡張計画

- AIタイトル生成の更なる最適化
- 予定の衝突検出機能
- Google Calendarとの直接同期
- ユーザー設定による予定テンプレート
- 定期的な予定の適切な処理
- メモリ内キャッシュの分散キャッシュ化

## 11. トラブルシューティング

### 11.1. Slackイベントが届かない

- Slack APIのイベント購読設定を確認
- URLとパスの正確性を確認
- 署名シークレットの正確性を確認
- サーバーログでリクエスト受信を確認

### 11.2. Gemini APIエラー

- APIキーの有効性確認
- レート制限の確認
- プロンプト設計の最適化
- モデル指定の確認（gemini-2.5-flash-preview-06-17）
- リトライ機能の動作確認

### 11.3. メモリ内キャッシュ関連問題

- キャッシュサイズの監視
- TTL設定の調整
- メモリリークの検出
- キャッシュクリーンアップの動作確認

### 11.4. Cloud Run関連問題

- 環境変数の設定確認
- サービスアカウント権限の確認
- メモリ設定の確認
- ログ分析による原因特定

**注意**: Firestoreは使用していません。問題が発生した場合はメモリ内キャッシュの動作を確認してください。